name: Basic Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache to ensure clean install
        # cache: 'npm'

    # 1. Automatically generate package-lock.json files (no manual action needed!)
    - name: Auto-generate package-lock.json files
      run: |
        echo "ðŸ”§ Automatically generating package-lock.json files..."
        echo "â„¹ï¸  Note: This happens automatically - no manual action required!"
        
        # Frontend package-lock.json
        echo "ðŸ“¦ Generating frontend package-lock.json..."
        npm install --package-lock-only
        if [ -f package-lock.json ]; then
          echo "âœ… Frontend package-lock.json generated successfully"
        else
          echo "âŒ Failed to generate frontend package-lock.json"
          exit 1
        fi
        
        # Backend package-lock.json
        echo "ðŸ“¦ Generating backend package-lock.json..."
        cd server
        npm install --package-lock-only
        if [ -f package-lock.json ]; then
          echo "âœ… Backend package-lock.json generated successfully"
        else
          echo "âŒ Failed to generate backend package-lock.json"
          exit 1
        fi
        cd ..
        
        echo "ðŸŽ‰ All package-lock.json files generated automatically!"
        echo "ðŸ“Š Ready for dependency scanning..."

    # 2. Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        cd server && npm ci && cd ..

    # 3. Basic secrets detection with TruffleHog
    - name: TruffleHog OSS - Secrets Detection
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true

    # 4. npm audit for dependency vulnerabilities
    - name: Run npm audit - Frontend
      run: |
        echo "Running npm audit for frontend..."
        npm audit --audit-level=moderate || echo "Frontend audit completed with warnings"
      continue-on-error: true

    - name: Run npm audit - Backend
      run: |
        echo "Running npm audit for backend..."
        cd server
        npm audit --audit-level=moderate || echo "Backend audit completed with warnings"
      continue-on-error: true

    # 5. Basic SAST with Semgrep (free tier)
    - name: Semgrep Security Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/typescript
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || '' }}
      continue-on-error: true

    # 6. CodeQL Analysis (GitHub's built-in security scanning)
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

    # 7. Upload Semgrep results if available
    - name: Upload Semgrep SARIF
      if: hashFiles('semgrep.sarif') != ''
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
        category: semgrep
      continue-on-error: true

    # 8. Security summary
    - name: Security Scan Summary
      run: |
        echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secrets Detection: TruffleHog scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency Audit: npm audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SAST Analysis: Semgrep and CodeQL completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Results available in Security tab" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Review findings in the Security tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Address any critical or high severity issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Update dependencies with security patches" >> $GITHUB_STEP_SUMMARY