name: Basic Security Scan

on:
  #push:
  #  branches: [ main, develop ]
  #pull_request:
  #  branches: [ main ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache to ensure clean install
        # cache: 'npm'

    # 1. Automatically generate package-lock.json files (no manual action needed!)
    - name: Auto-generate package-lock.json files
      run: |
        echo "ðŸ”§ Automatically generating package-lock.json files..."
        echo "â„¹ï¸  Note: This happens automatically - no manual action required!"
        
        # Frontend package-lock.json
        echo "ðŸ“¦ Generating frontend package-lock.json..."
        npm install --package-lock-only
        if [ -f package-lock.json ]; then
          echo "âœ… Frontend package-lock.json generated successfully"
        else
          echo "âŒ Failed to generate frontend package-lock.json"
          exit 1
        fi
        
        # Backend package-lock.json with robust error handling
        echo "ðŸ“¦ Generating backend package-lock.json..."
        cd server
        
        # Method 1: Standard approach
        if npm install --package-lock-only 2>&1; then
          if [ -f package-lock.json ]; then
            echo "âœ… Backend package-lock.json generated successfully"
          else
            echo "âš ï¸ npm command succeeded but no lock file created"
          fi
        else
          echo "âš ï¸ Standard approach failed, trying alternatives..."
        fi
        
        # Method 2: If still no lock file, try with cache clean
        if [ ! -f package-lock.json ]; then
          echo "ðŸ”„ Trying with clean cache..."
          npm cache clean --force
          npm install --package-lock-only --no-audit --no-fund 2>&1
        fi
        
        # Method 3: If still no lock file, try full install then extract
        if [ ! -f package-lock.json ]; then
          echo "ðŸ”„ Trying full install approach..."
          npm install --no-audit --no-fund
        fi
        
        # Final check - continue gracefully if no lock file
        if [ -f package-lock.json ]; then
          echo "âœ… Backend package-lock.json available"
        else
          echo "âš ï¸ Backend package-lock.json generation failed, continuing without it"
          echo "Backend security scanning will use package.json only"
        fi
        cd ..
        
        echo "ðŸŽ‰ All package-lock.json files generated automatically!"
        echo "ðŸ“Š Ready for dependency scanning..."

    # 2. Install dependencies with error handling
    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        
        # Frontend dependencies
        echo "Installing frontend dependencies..."
        if npm ci; then
          echo "âœ… Frontend dependencies installed successfully"
        else
          echo "âŒ Frontend npm ci failed, trying npm install..."
          npm install
        fi
        
        # Backend dependencies
        echo "Installing backend dependencies..."
        cd server
        if [ -f package-lock.json ]; then
          echo "Using package-lock.json for backend dependencies..."
          if npm ci; then
            echo "âœ… Backend dependencies installed successfully with npm ci"
          else
            echo "âŒ Backend npm ci failed, trying npm install..."
            npm install
          fi
        else
          echo "No package-lock.json found, using npm install for backend..."
          npm install
          echo "âœ… Backend dependencies installed with npm install"
        fi
        cd ..

    # 3. Basic secrets detection with TruffleHog
    - name: TruffleHog OSS - Secrets Detection
      run: |
        echo "ðŸ” Running TruffleHog secrets detection..."
        
        # Install TruffleHog
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
        # Run filesystem scan (works without git history)
        trufflehog filesystem . --only-verified --no-update || echo "TruffleHog scan completed"
        
        echo "âœ… Secrets detection completed"
      continue-on-error: true

    # 4. npm audit for dependency vulnerabilities
    - name: Run npm audit - Frontend
      run: |
        echo "Running npm audit for frontend..."
        npm audit --audit-level=moderate || echo "Frontend audit completed with warnings"
      continue-on-error: true

    - name: Run npm audit - Backend
      run: |
        echo "Running npm audit for backend..."
        cd server
        npm audit --audit-level=moderate || echo "Backend audit completed with warnings"
      continue-on-error: true

    # 5. Basic SAST with Semgrep (free tier)
    - name: Semgrep Security Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/typescript
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN || '' }}
      continue-on-error: true

    # 6. ESLint Security Analysis (works on private repos)
    - name: ESLint Security Scan
      run: |
        echo "ðŸ” Running ESLint security analysis..."
        
        # Install ESLint security plugins
        npm install --no-save eslint @eslint/js eslint-plugin-security eslint-plugin-no-secrets
        
        # Create ESLint security config
        cat > .eslintrc.security.js << 'EOF'
        module.exports = {
          extends: ['@eslint/js/recommended'],
          plugins: ['security', 'no-secrets'],
          rules: {
            // Security rules
            'security/detect-buffer-noassert': 'error',
            'security/detect-child-process': 'warn',
            'security/detect-disable-mustache-escape': 'error',
            'security/detect-eval-with-expression': 'error',
            'security/detect-no-csrf-before-method-override': 'error',
            'security/detect-non-literal-fs-filename': 'warn',
            'security/detect-non-literal-regexp': 'warn',
            'security/detect-non-literal-require': 'warn',
            'security/detect-object-injection': 'warn',
            'security/detect-possible-timing-attacks': 'warn',
            'security/detect-pseudoRandomBytes': 'error',
            'security/detect-unsafe-regex': 'error',
            
            // Secret detection rules
            'no-secrets/no-secrets': ['error', {
              'tolerance': 4.2,
              'additionalRegexes': {
                'Basic Auth': 'Authorization: Basic [A-Za-z0-9+/=]+',
                'JWT': 'ey[A-Za-z0-9_-]*\\.[A-Za-z0-9_-]*\\.[A-Za-z0-9_-]*'
              }
            }]
          },
          env: {
            node: true,
            es2021: true
          },
          parserOptions: {
            ecmaVersion: 12,
            sourceType: 'module'
          }
        };
        EOF
        
        # Run ESLint security scan on frontend
        echo "ðŸ“¦ Scanning frontend code..."
        npx eslint --config .eslintrc.security.js --ext .js,.jsx,.ts,.tsx src/ || echo "Frontend security scan completed with findings"
        
        # Run ESLint security scan on backend
        echo "ðŸ“¦ Scanning backend code..."
        cd server
        npx eslint --config ../.eslintrc.security.js --ext .js,.jsx,.ts,.tsx . || echo "Backend security scan completed with findings"
        cd ..
        
        echo "âœ… ESLint security analysis completed"
      continue-on-error: true

    # 7. Upload security results as artifacts (for private repositories)
    - name: Upload Security Results
      uses: actions/upload-artifact@v5
      with:
        name: basic-security-results
        path: |
          *.sarif
          package-lock.json
          server/package-lock.json
        retention-days: 30
      continue-on-error: true

    # 8. Security summary
    - name: Security Scan Summary
      run: |
        echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Secrets Detection: TruffleHog scan completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency Audit: npm audit completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… SAST Analysis: Semgrep and ESLint security completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Results available as artifacts (download from Actions tab)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Download security results from Actions artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Address any critical or high severity issues" >> $GITHUB_STEP_SUMMARY
        echo "3. Update dependencies with security patches" >> $GITHUB_STEP_SUMMARY