name: Reliable Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'package*.json'
      - 'server/package*.json'
      - 'Dockerfile*'

env:
  NODE_VERSION: '18'

jobs:
  reliable-security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache to ensure clean install

    # 1. Generate package-lock.json files
    - name: Generate lock files
      run: |
        echo "Generating package-lock.json files..."
        # Frontend
        npm install --package-lock-only
        echo "Frontend lock file generated"
        
        # Backend
        cd server
        npm install --package-lock-only
        echo "Backend lock file generated"
        cd ..

    # 2. Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        cd server && npm ci && cd ..

    # 3. Secrets Detection
    - name: TruffleHog OSS - Secrets Detection
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD
        extra_args: --debug --only-verified
      continue-on-error: true

    # 4. Dependency Vulnerability Scanning
    - name: Run npm audit - Frontend
      run: |
        echo "Running npm audit for frontend..."
        npm audit --audit-level=moderate --production || echo "Frontend audit completed with findings"
      continue-on-error: true

    - name: Run npm audit - Backend
      run: |
        echo "Running npm audit for backend..."
        cd server
        npm audit --audit-level=moderate --production || echo "Backend audit completed with findings"
      continue-on-error: true

    # 5. SAST with Semgrep
    - name: Semgrep Security Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/typescript
          p/react
          p/nodejs
        generateSarif: "1"
      continue-on-error: true

    # 6. CodeQL Analysis
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript
        queries: security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:javascript"

    # 7. Container Security (if Dockerfiles exist)
    - name: Run Trivy vulnerability scanner
      if: hashFiles('Dockerfile*') != ''
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
      continue-on-error: true

    # 8. Infrastructure as Code Security
    - name: Checkov IaC Security Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: dockerfile,kubernetes,github_actions
        output_format: sarif
        output_file_path: checkov-results.sarif
        quiet: true
        soft_fail: true
      continue-on-error: true

    # 9. License Compliance
    - name: License Check
      run: |
        echo "Checking licenses..."
        npx license-checker --summary || echo "License check completed"
        cd server && npx license-checker --summary || echo "Server license check completed"
      continue-on-error: true

    # 10. Upload SARIF results
    - name: Upload Semgrep SARIF
      if: hashFiles('semgrep.sarif') != ''
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: semgrep.sarif
        category: semgrep
      continue-on-error: true

    - name: Upload Trivy SARIF
      if: hashFiles('trivy-fs-results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: trivy-fs-results.sarif
        category: trivy-filesystem
      continue-on-error: true

    - name: Upload Checkov SARIF
      if: hashFiles('checkov-results.sarif') != ''
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: checkov-results.sarif
        category: checkov-iac
      continue-on-error: true

    # 11. Security Summary
    - name: Security Scan Summary
      run: |
        echo "## ðŸ”’ Reliable Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scans Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Secrets Detection**: TruffleHog scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Dependency Audit**: npm audit (frontend & backend)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **SAST Analysis**: Semgrep security rules" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Code Analysis**: GitHub CodeQL" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Container Security**: Trivy filesystem scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **IaC Security**: Checkov infrastructure scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **License Compliance**: License checker" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results:" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Security findings** are available in the [Security tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” **Detailed logs** are available in this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review any security findings in the Security tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Address critical and high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "3. Update dependencies with security patches" >> $GITHUB_STEP_SUMMARY
        echo "4. Monitor for new vulnerabilities with Dependabot" >> $GITHUB_STEP_SUMMARY

    # 12. Create artifact with scan results
    - name: Upload Security Scan Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: |
          *.sarif
          package-lock.json
          server/package-lock.json
        retention-days: 30
      continue-on-error: true