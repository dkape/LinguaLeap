name: Reliable Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'package*.json'
  #     - 'server/package*.json'
  #     - 'Dockerfile*'

env:
  NODE_VERSION: '18'

jobs:
  reliable-security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        # Remove cache to ensure clean install

    # 1. Automatically generate package-lock.json files
    - name: Auto-generate package-lock.json files
      run: |
        echo "ðŸ”§ Automatically generating package-lock.json files..."
        echo "â„¹ï¸  This is fully automated - no manual steps required!"
        
        # Frontend
        echo "ðŸ“¦ Frontend package-lock.json..."
        npm install --package-lock-only
        [ -f package-lock.json ] && echo "âœ… Frontend: Success" || echo "âŒ Frontend: Failed"
        
        # Backend
        echo "ðŸ“¦ Backend package-lock.json..."
        cd server
        npm install --package-lock-only
        [ -f package-lock.json ] && echo "âœ… Backend: Success" || echo "âŒ Backend: Failed"
        cd ..
        
        echo "ðŸŽ‰ Automatic generation complete!"

    # 2. Install dependencies
    - name: Install dependencies
      run: |
        npm ci
        cd server && npm ci && cd ..

    # 3. Secrets Detection
    - name: TruffleHog OSS - Secrets Detection
      run: |
        echo "ðŸ” Running TruffleHog secrets detection..."
        
        # Install TruffleHog
        curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin
        
        # Run filesystem scan (works regardless of git history)
        trufflehog filesystem . --only-verified --no-update || echo "TruffleHog scan completed"
        
        echo "âœ… Secrets detection completed"
      continue-on-error: true

    # 4. Dependency Vulnerability Scanning
    - name: Run npm audit - Frontend
      run: |
        echo "Running npm audit for frontend..."
        npm audit --audit-level=moderate --production || echo "Frontend audit completed with findings"
      continue-on-error: true

    - name: Run npm audit - Backend
      run: |
        echo "Running npm audit for backend..."
        cd server
        npm audit --audit-level=moderate --production || echo "Backend audit completed with findings"
      continue-on-error: true

    # 5. SAST with Semgrep
    - name: Semgrep Security Scan
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/javascript
          p/typescript
          p/react
          p/nodejs
        generateSarif: "1"
      continue-on-error: true

    # 6. Alternative Static Analysis (for private repositories)
    - name: ESLint Security Analysis
      run: |
        echo "ðŸ” Running ESLint security analysis..."
        
        # Install security plugins
        npm install --no-save eslint-plugin-security eslint-plugin-no-secrets
        
        # Run security-focused linting
        npx eslint . --ext .js,.jsx,.ts,.tsx --config .eslintrc.security.js || echo "ESLint security scan completed with findings"
        
        # Backend security linting
        cd server
        npx eslint . --ext .js,.jsx,.ts,.tsx || echo "Backend ESLint scan completed with findings"
        cd ..
        
        echo "âœ… Static analysis completed"
      continue-on-error: true

    # 7. Container Security (if Dockerfiles exist)
    - name: Run Trivy vulnerability scanner
      if: hashFiles('Dockerfile*') != ''
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
      continue-on-error: true

    # 8. Infrastructure as Code Security
    - name: Checkov IaC Security Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: dockerfile,kubernetes,github_actions
        output_format: sarif
        output_file_path: checkov-results.sarif
        quiet: true
        soft_fail: true
      continue-on-error: true

    # 9. License Compliance
    - name: License Check
      run: |
        echo "Checking licenses..."
        npx license-checker --summary || echo "License check completed"
        cd server && npx license-checker --summary || echo "Server license check completed"
      continue-on-error: true

    # 10. Upload security scan results as artifacts (for private repositories)
    - name: Upload Security Scan Results
      uses: actions/upload-artifact@v5
      with:
        name: security-scan-results
        path: |
          *.sarif
          package-lock.json
          server/package-lock.json
        retention-days: 30
      continue-on-error: true

    # 11. Security Summary
    - name: Security Scan Summary
      run: |
        echo "## ðŸ”’ Reliable Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Scans Completed:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Secrets Detection**: TruffleHog scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Dependency Audit**: npm audit (frontend & backend)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **SAST Analysis**: Semgrep security rules" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Static Analysis**: ESLint security rules" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Container Security**: Trivy filesystem scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **IaC Security**: Checkov infrastructure scan" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **License Compliance**: License checker" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results:" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Security findings** are available in the [Security tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ” **Detailed logs** are available in this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review any security findings in the Security tab" >> $GITHUB_STEP_SUMMARY
        echo "2. Address critical and high severity vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "3. Update dependencies with security patches" >> $GITHUB_STEP_SUMMARY
        echo "4. Monitor for new vulnerabilities with Dependabot" >> $GITHUB_STEP_SUMMARY

    # 12. Create artifact with scan results
    - name: Upload Security Scan Artifacts
      uses: actions/upload-artifact@v5
      with:
        name: security-scan-results
        path: |
          *.sarif
          package-lock.json
          server/package-lock.json
        retention-days: 30
      continue-on-error: true